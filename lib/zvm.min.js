!function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define([],a);else{var b;b="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,b.ZVM=a()}}(function(){var a,b,c;return function d(a,b,c){function e(g,h){if(!b[g]){if(!a[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=b[g]={exports:{}};a[g][0].call(k.exports,function(b){var c=a[g][1][b];return e(c?c:b)},k,k.exports,d,a,b,c)}return b[g].exports}for(var f="function"==typeof require&&require,g=0;g<c.length;g++)e(c[g]);return e}({1:[function(a,b,c){function d(a,b,c){return c=c||{},b&&(c.func=b),a.subClass(c)}var e=a("../common/utils.js"),f=e.Class,g=e.U2S16,h=f.subClass({init:function(a,b){this.e=a,this.v=b},toString:function(){return this.v},U2S:function(){return g(this.v)}}),i=h.subClass({toString:function(){var a=this.v;return this.indirect?"e.indirect("+a+")":0===a?"s.pop()":--a<15?"l["+a+"]":"m.getUint16("+(this.e.globals+2*(a-15))+")"},store:function(a){var b=this.v;return this.indirect?"e.indirect("+b+","+a+")":this.returnval?"e.variable("+b+","+a+")":0===b?"s.push("+a+")":--b<15?"l["+b+"]="+a:"m.setUint16("+(this.e.globals+2*(b-15))+","+a+")"},U2S:function(){return"e.U2S("+this+")"}}),j=f.subClass({init:function(a,b,c,d,e,f){this.e=a,this.context=b,this.code=c,this.pc=d,this.labels=[this.pc+"/"+this.code],this.next=e,this.operands=f,this.post&&this.post()},toString:function(){return this.label()+(this.func?this.func.apply(this,this.operands):"")},args:function(a){return this.operands.join(a)},label:function(){return"/* "+this.labels.join()+" */ "}}),k=j.subClass({stopper:1}),l=k.subClass({storer:1,post:function(){this.storer=this.operands.pop(),this.origfunc=this.func,this.func=this.newfunc},newfunc:function(){return"e.pc="+this.next+";"+this.origfunc.apply(this,arguments)}}),m=f.subClass({init:function(a,b){this.ops=a||[],this.code=b||"||"},toString:function(){for(var a,b=0,c=[];b<this.ops.length;)a=this.ops[b++],c.push(a.func?(a.iftrue?"":"!(")+a.func.apply(a,a.operands)+(a.iftrue?"":")"):a);return(this.invert?"(!(":"(")+c.join(this.code)+(this.invert?"))":")")}}),n=j.subClass({brancher:1,keyword:"if",post:function(){var a,b,c=this.operands.pop(),d=c[1];this.iftrue=c[0],0===d||1===d?a="e.ret("+d+")":(d+=this.next-2,this.context.targets.push(d),a="e.pc="+d),this.result=a+";return",this.offset=d,this.cond=new m([this]),this.context.ops.length&&(b=this.context.ops.pop(),b.offset===d?(this.cond.ops.unshift(b.cond),this.labels=b.labels,this.labels.push(this.pc+"/"+this.code)):this.context.ops.push(b))},toString:function(){var a=this.result;return a instanceof s&&(this.e.env.debug&&(a.context=this.context),a+=a.stopper?"; return":"",this.result.ops.length>1&&(a="\n"+a+"\n",this.e.env.debug&&(a+=this.context.spacer))),this.label()+this.keyword+this.cond+" {"+a+"}"}}),o=n.subClass({storer:1,post:function(){o["super"].post.call(this),this.storer=this.operands.pop(),this.storer.returnval=1,this.origfunc=this.func,this.func=this.newfunc},newfunc:function(){return this.storer.store(this.origfunc.apply(this,arguments))}}),p=j.subClass({storer:1,post:function(){this.storer=this.operands.pop()},toString:function(){var a=p["super"].toString.call(this);return this.storer?this.storer.store(a):a}}),q=k.subClass({result:{v:-1},toString:function(){return this.label()+"e.call("+this.operands.shift()+","+this.result.v+","+this.next+",["+this.args()+"])"}}),r=q.subClass({storer:1,post:function(){this.result=this.operands.pop()}}),s=f.subClass({init:function(a,b){this.e=a,this.pc=b,this.pre=[],this.ops=[],this.post=[],this.targets=[],a.env.debug&&(this.spacer="")},toString:function(){return this.e.env.debug?(this.context&&(this.spacer=this.context.spacer+"  "),this.pre.join("")+(this.ops.length>1?this.spacer:"")+this.ops.join(";\n"+this.spacer)+this.post.join("")):this.pre.join("")+this.ops.join(";")+this.post.join("")}}),t=s.subClass({toString:function(){return this.pre.unshift("var l=e.l,m=e.m,s=e.s;\n"),t["super"].toString.call(this)}});b.exports={Operand:h,Variable:i,Opcode:j,Stopper:k,Pauser:l,BrancherLogic:m,Brancher:n,BrancherStorer:o,Storer:p,Caller:q,CallerStorer:r,Context:s,RoutineContext:t,opcode_builder:d}},{"../common/utils.js":3}],2:[function(a,b,c){function d(a,b){return a.charCodeAt(b)<<24|a.charCodeAt(b+1)<<16|a.charCodeAt(b+2)<<8|a.charCodeAt(b+3)}function e(a){return String.fromCharCode.call(null,a>>24&255,a>>16&255,a>>8&255,255&a)}var f=a("./utils.js"),g=f.Class,h=g.subClass({init:function(a){if(this.type="",this.chunks=[],a){if("FORM"!==a.substr(0,4))throw new Error("Not an IFF file");this.type=a.substr(8,4);for(var b,c=12,e=a.length;e>c;){if(b=d(a,c+4),0>b||b+c>e)throw new Error("IFF chunk out of range");this.chunks.push({type:a.substr(c,4),offset:c,data:a.substr(c+8,b)}),c+=8+b,b%2&&c++}}},write:function(){for(var a,b,c=this.type,d=0,f=this.chunks.length;f>d;)a=this.chunks[d++],b=a.data,c+=a.type+e(b.length)+b,b.length%2&&(c+="\x00");return"FORM"+e(c.length)+c}}),i=h.subClass({init:function(a){if(this["super"].init.call(a),a){if("IFZS"!==this.type)throw new Error("Not a Quetzal savefile");for(var b,c,d=0,e=this.chunks.length;e>d;)b=this.chunks[d].type,c=this.chunks[d++].data,"CMem"===b||"UMem"===b?(this.memory=a,this.compressed="CMem"===b):"Stks"===b?this.stacks=a:"IFhd"===b&&(this.release=c.slice(0,2),this.serial=c.slice(2,8),this.checksum=c.slice(8,10),this.pc=c[10]<<16|c[11]<<8|c[12])}},write:function(){this.type="IFZS";var a=this.pc,b=this.release.concat(this.serial,this.checksum,a>>16&255,a>>8&255,255&a);return this.chunks=[{type:"IFhd",data:b},{type:this.compressed?"CMem":"UMem",data:this.memory},{type:"Stks",data:this.stacks}],this["super"].write.call(this)}});b.exports={IFF:h,Quetzal:i}},{"./utils.js":3}],3:[function(a,b,c){function d(){for(var a,b,c=arguments[0],d=1;d<arguments.length;){a=arguments[d++];for(b in a)c[b]=a[b]}return c}function e(){}function f(a){return d(new DataView(a),{getBuffer8:function(a,b){return new Uint8Array(this.buffer.slice(a,a+b))},getBuffer16:function(a,b){return new Uint16Array(this.buffer.slice(a,a+2*b))},setBuffer8:function(a,b){new Uint8Array(this.buffer).set(b,a)}})}function g(a){return a<<16>>16}function h(a){return 65535&a}function i(a){for(var b=0,c=a.length,d=[];c>b;)d[b/2]=a[b++]<<8|a[b++];return d}e.subClass=function(a){function b(){this.init&&this.init.apply(this,arguments)}return b.prototype=d(Object.create(this.prototype),a),b.subClass=this.subClass,b["super"]=b.prototype["super"]=this.prototype,b},b.exports={extend:d,Class:e,MemoryView:f,U2S16:g,S2U16:h,byte_to_word:i}},{}],4:[function(a,b,c){var d=a("./common/utils.js"),e=d.Class,f=d.extend,g={init:function(){this.jit={},this.env={width:80}},inputEvent:function(a){var b=this.m,c=a.code;if(!a.env||(f(this.env,a.env),c)){if("load"===c)return void(this.data=new Uint8Array(a.data));this.orders=[],"restart"===c&&this.restart(),"save"===c&&this.save_restore_result(a.result||1),"restore"===c&&(this.m||this.restart(),a.data?this.restore_file(a.data):this.save_restore_result(0)),"read"===c&&this.handle_input(a),"char"===c&&this.variable(this.read_data.storer,this.keyinput(a.response)),"get_cursor"===c&&(b.setUint16(a.addr,a.pos[0]+1),b.setUint16(a.addr+2,a.pos[1]+1)),this.run()}},run:function(){var a,b,c=new Date,d=0;for(this.stop=0;!this.stop;)if(a=this.pc,this.jit[a]||this.compile(),b=this.jit[a](this),isNaN(b)||this.ret(b),++d%5e4===0&&new Date-c>5e3)return void this.act("tick")},compile:function(){var a=this.disassemble(),b,c;this.env.debug?(b=""+a,c=eval("(0,function JIT_"+a.pc+"(e){"+b+"})"),c.context=a,c.code=b,a.name&&(c.name=a.name),this.jit[a.pc]=c):this.jit[a.pc]=new Function("e",""+a),a.pc<this.staticmem&&this.warn("Caching a JIT function in dynamic memory: "+a.pc)},act:function(a,b){b=b||{},183===a&&(a="restart"),186===a&&(a="quit"),this.ui.flush(),this.ui.status.length&&(this.orders.push({code:"stream",to:"status",data:this.ui.status}),this.ui.status=[]),b.code=a,this.orders.push(b),this.stop=1,this.outputEvent&&this.outputEvent(this.orders)}},h=e.subClass(f(g,a("./zvm/runtime.js"),a("./zvm/text.js"),a("./zvm/disassembler.js")));b.exports=h},{"./common/utils.js":3,"./zvm/disassembler.js":5,"./zvm/runtime.js":7,"./zvm/text.js":8}],5:[function(a,b,c){var d=a("../common/ast.js");b.exports.disassemble=function(){function a(a,b){for(var c=0;4>c;c++)b.push((192&a)>>6),a<<=2}for(var b,c,e,f,g,h,i,j=this.m,k=this.opcodes,l=new d.RoutineContext(this,this.pc);;){if(c=b=this.pc,f=j.getUint8(b++),190===f?(h=-1,f=j.getUint8(b++)+1e3):128&f?64&f?(h=-1,32&f||(f&=31)):(h=[(48&f)>>4],h[0]<3&&(f&=207)):(h=[64&f?2:1,32&f?2:1],f&=31),!k[f])throw this.log(""+l),this.stop=1,new Error("Unknown opcode #"+f+" at pc="+c);for(g=k[f].prototype,-1===h&&(h=[],a(j.getUint8(b++),h),(236===f||250===f)&&a(j.getUint8(b++),h)),i=[],e=0;e<h.length;)0===h[e]&&(i.push(new d.Operand(this,j.getUint16(b))),b+=2),1===h[e]&&i.push(new d.Operand(this,j.getUint8(b++))),2===h[e++]&&i.push(new d.Variable(this,j.getUint8(b++)));if(g.storer&&i.push(new d.Variable(this,j.getUint8(b++))),g.brancher&&(e=j.getUint8(b++),i.push([128&e,64&e?63&e:(e<<8|j.getUint8(b++))<<18>>18])),g.printer)for(i.push(b);b<this.eof&&(e=j.getUint8(b),b+=2,!(128&e)););if(this.pc=b,l.ops.push(new k[f](this,l,f,c,b,i)),e=0,g.stopper&&!e)break}return l}},{"../common/ast.js":1}],6:[function(a,b,c){var d=a("../common/ast.js"),e=d.Variable,f=d.Opcode,g=d.Stopper,h=d.Pauser,i=d.Brancher,j=d.BrancherStorer,k=d.Storer,l=d.Caller,m=d.CallerStorer,n=d.opcode_builder,o=function(a){return""+a},p=new e(this.e,0),q=n(i,function(){return 1}),r=n(k,function(a){return"e.S2U(~"+a+")"}),s=k.subClass({storer:0,post:function(){var a=this.operands,b=a[0],c=b instanceof e;a[0]=new e(this.e,c?b:b.v),(c||0===b.v)&&(a[0].indirect=1),this.storer=142===this.code?a.pop():a.shift(),0===a.length&&a.push(p)},func:o}),t=f.subClass({func:function(a){var b=a.v-1,c=this.code%2?1:-1;return a instanceof e||b>14?"e.incdec("+a+","+c+")":(0>b?"e.s[e.s.length-1]=e.S2U(e.s[e.s.length-1]+":"e.l["+b+"]=e.S2U(e.l["+b+"]+")+c+")"}}),u=g.subClass({brancher:1,toString:function(){return"e."+(181===this.code?"save":"restore")+"("+(this.pc+1)+")"}});b.exports=function(a){return{1:n(i,function(){return 2===arguments.length?this.args("==="):"e.jeq("+this.args()+")"}),2:n(i,function(a,b){return a.U2S()+"<"+b.U2S()}),3:n(i,function(a,b){return a.U2S()+">"+b.U2S()}),4:n(i,function(a,b){return"e.U2S(e.incdec("+a+",-1))<"+b.U2S()}),5:n(i,function(a,b){return"e.U2S(e.incdec("+a+",1))>"+b.U2S()}),6:n(i,function(){return"e.jin("+this.args()+")"}),7:n(i,function(){return"e.test("+this.args()+")"}),8:n(k,function(){return this.args("|")}),9:n(k,function(){return this.args("&")}),10:n(i,function(){return"e.test_attr("+this.args()+")"}),11:n(f,function(){return"e.set_attr("+this.args()+")"}),12:n(f,function(){return"e.clear_attr("+this.args()+")"}),13:s,14:n(f,function(){return"e.insert_obj("+this.args()+")"}),15:n(k,function(a,b){return"m.getUint16(e.S2U("+a+"+2*"+b.U2S()+"))"}),16:n(k,function(a,b){return"m.getUint8(e.S2U("+a+"+"+b.U2S()+"))"}),17:n(k,function(){return"e.get_prop("+this.args()+")"}),18:n(k,function(){return"e.find_prop("+this.args()+")"}),19:n(k,function(){return"e.find_prop("+this.args(",0,")+")"}),20:n(k,function(){return"e.S2U("+this.args("+")+")"}),21:n(k,function(){return"e.S2U("+this.args("-")+")"}),22:n(k,function(){return"e.S2U("+this.args("*")+")"}),23:n(k,function(a,b){return"e.S2U(parseInt("+a.U2S()+"/"+b.U2S()+"))"}),24:n(k,function(a,b){return"e.S2U("+a.U2S()+"%"+b.U2S()+")"}),25:m,26:l,27:n(f,function(){return"e.ui.set_colour("+this.args()+")"}),28:n(g,function(a,b){return"while(e.call_stack.length>"+b+"){e.call_stack.shift()}return "+a}),128:n(i,function(a){return a+"===0"}),129:n(j,function(a){return"e.get_sibling("+a+")"}),130:n(j,function(a){return"e.get_child("+a+")"}),131:n(k,function(a){return"e.get_parent("+a+")"}),132:n(k,function(a){return"e.get_prop_len("+a+")"}),133:t,134:t,135:n(f,function(a){return"e.print(2,"+a+")"}),136:m,137:n(f,function(a){return"e.remove_obj("+a+")"}),138:n(f,function(a){return"e.print(3,"+a+")"}),139:n(g,function(a){return"return "+a}),140:n(g,function(a){return"e.pc="+a.U2S()+"+"+(this.next-2)}),141:n(f,function(a){return"e.print(2,"+a+"*"+this.e.addr_multipler+")"}),142:s.subClass({storer:1}),143:a?r:l,176:n(g,function(){return"return 1"}),177:n(g,function(){return"return 0"}),178:n(f,function(a){return"e.print(2,"+a+")"},{printer:1}),179:n(g,function(a){return"e.print(2,"+a+");e.print(1,13);return 1"},{printer:1}),180:f,181:u,182:u,183:n(g,function(){return"e.act(183)"}),184:n(g,function(a){return"return "+a},{post:function(){this.operands.push(p)}}),185:a?n(f,function(){return"s.pop()"}):n(k,function(){return"e.call_stack.length"}),186:n(g,function(){return"e.act(186)"}),187:n(f,function(){return"e.print(1,13)"}),188:a?n(g,function(){return"e.pc="+this.next+";e.ui.v3_status();e.act()"}):f,189:q,191:q,224:m,225:n(f,function(a,b,c){return"m.setUint16(e.S2U("+a+"+2*"+b.U2S()+"),"+c+")"}),226:n(f,function(a,b,c){return"m.setUint8(e.S2U("+a+"+"+b.U2S()+"),"+c+")"}),227:n(f,function(){return"e.put_prop("+this.args()+")"}),228:a?n(g,function(){return"e.pc="+this.next+";e.read(0,"+this.args()+")"}):n(h,function(){return"e.read("+this.storer.v+","+this.args()+")"}),229:n(f,function(a){return"e.print(4,"+a+")"}),230:n(f,function(a){return"e.print(0,"+a.U2S()+")"}),231:n(k,function(a){return"e.random("+a.U2S()+")"}),232:n(k,o,{post:function(){this.storer=p},storer:0}),233:s,234:n(f,function(a){return"e.ui.split_window("+a+")"}),235:n(f,function(a){return"e.ui.set_window("+a+")"}),236:m,237:n(f,function(a){return"e.ui.erase_window("+a.U2S()+")"}),238:n(f,function(a){return"e.ui.erase_line("+a+")"}),239:n(f,function(){return"e.ui.set_cursor("+this.args()+")"}),240:n(h,function(a){return"e.ui.get_cursor("+a+")"}),241:n(f,function(a){return"e.ui.set_style("+a+")"}),242:f,243:n(f,function(){return"e.output_stream("+this.args()+")"}),244:f,245:f,246:n(h,function(){return"e.read_char("+this.storer.v+","+(this.args()||"1")+")"}),247:n(j,function(){return"e.scan_table("+this.args()+")"}),248:r,249:l,250:l,251:n(f,function(){return"e.tokenise("+this.args()+")"}),252:n(f,function(){return"e.encode_text("+this.args()+")"}),253:n(f,function(){return"e.copy_table("+this.args()+")"}),254:n(f,function(){return"e.print_table("+this.args()+")"}),255:n(i,function(a){return a+"<=e.call_stack[0][4]"}),1e3:n(h,function(){return"e.save("+(this.next-1)+")"}),1001:n(h,function(){return"e.restore("+(this.next-1)+")"}),1002:n(k,function(a,b){return"e.S2U(e.log_shift("+a+","+b.U2S()+"))"}),1003:n(k,function(a,b){return"e.S2U(e.art_shift("+a.U2S()+","+b.U2S()+"))"}),1004:n(k,function(a){return"e.ui.set_font("+a+")"}),1009:n(k,function(){return"e.save_undo("+this.next+","+this.storer.v+")"}),1010:n(f,function(){return"if(e.restore_undo())return"},{storer:1}),1011:n(f,function(a){return"e.print(1,"+a+")"}),1012:n(k,function(){return 3}),1013:n(f,function(){return"e.ui.set_true_colour("+this.args()+")"}),1014:f.subClass({brancher:1}),1030:n(k,function(){return"e.gestalt("+this.args()+")"})}}},{"../common/ast.js":1}],7:[function(a,b,c){var d=a("../common/utils.js"),e=d.extend,f=d.U2S16,g=d.S2U16,h=d.byte_to_word,i=a("../common/file.js");b.exports={art_shift:function(a,b){return b>0?a<<b:a>>-b},call:function(a,b,c,d){if(0===a)return b>=0&&this.variable(b,0),this.pc=c;var e,f,g=this.l.length,h=d.length;for(this.pc=a*this.addr_multipler,f=this.m.getUint8(this.pc++),d=d.slice(0,f),e=d.length;f>e;e++)d.push(this.version3?this.m.getUint16(this.pc+2*e):0);this.version3&&(this.pc+=2*f),this.l=d.concat(this.l),this.call_stack.unshift([c,b,f,this.s.length,h,g])},clear_attr:function(a,b){var c=this.objects+(this.version3?9:14)*a+b/8|0;this.m.setUint8(c,this.m.getUint8(c)&~(128>>b%8))},copy_table:function(a,b,c){c=f(c);var d=this.m,e=0,g=0>c;if(c=Math.abs(c),0!==b)if(g)for(;c>e;)d.setUint8(b+e,d.getUint8(a+e++));else d.setBuffer8(b,d.getBuffer8(a,c));else for(;c>e;)d.setUint8(a+e++,0)},encode_text:function(a,b,c,d){this.m.setBuffer8(d,this.encode(this.m.getBuffer8(a+c,b)))},extension_table:function(a,b){var c=this.extension;return!c||a>this.extension_count?0:(c+=2*a,void 0===b?this.m.getUint16(c):void this.e.setUint16(c,b))},find_prop:function(a,b,c){var d,e,f=this.m,g=this.version3,h=0,i=f.getUint16(this.objects+(g?9:14)*a+(g?7:12));for(i+=2*f.getUint8(i)+1;;){if(d=f.getUint8(i),e=d&(g?31:63),h===c)return e;if(e===b)return i+(!g&&128&d?2:1);if(b>e)return 0;h=e,g?i+=(d>>5)+2:128&d?(e=63&f.getUint8(i+1),i+=e?e+2:66):i+=64&d?3:2}},gestalt:function(a){switch(a){case 1:return 258;case 8192:return 1;case 8193:case 8194:return 2}return 0},get_child:function(a){return this.version3?this.m.getUint8(this.objects+9*a+6):this.m.getUint16(this.objects+14*a+10)},get_sibling:function(a){return this.version3?this.m.getUint8(this.objects+9*a+5):this.m.getUint16(this.objects+14*a+8)},get_parent:function(a){return this.version3?this.m.getUint8(this.objects+9*a+4):this.m.getUint16(this.objects+14*a+6)},get_prop:function(a,b){var c,d=this.m,e=this.find_prop(a,b);return e?(c=d.getUint8(e-1),d[(this.version3?c>>5:64&c)?"getUint16":"getUint8"](e)):d.getUint16(this.properties+2*(b-1))},get_prop_len:function(a){if(0===a)return 0;var b=this.m.getUint8(a-1);return this.version3?(b>>5)+1:128&b?(b&=63,0===b?64:b):64&b?2:1},handle_input:function(a){var b=this.m,c=this.read_data,d=a.response;this._print(d+"\r"),d=this.text_to_zscii(d.toLowerCase()),d.length>c.len&&(d=d.slice(0,c.len)),this.version3?(d.push(0),b.setBuffer8(c.buffer+1,d)):(b.setUint8(c.buffer+1,d.length),b.setBuffer8(c.buffer+2,d),this.variable(c.storer,isNaN(a.terminator)?13:a.terminator)),c.parse&&this.tokenise(c.buffer,c.parse)},incdec:function(a,b){var c,d;return 0===a?(c=g(this.s.pop()+b),this.s.push(c),c):--a<15?this.l[a]=g(this.l[a]+b):(d=this.globals+2*(a-15),c=this.m.getUint16(d)+b,this.m.setUint16(d,c),c)},indirect:function(a,b){return 0===a?arguments.length>1?this.s[this.s.length-1]=b:this.s[this.s.length-1]:this.variable(a,b)},insert_obj:function(a,b){this.remove_obj(a),this.set_family(a,b,b,a,a,this.get_child(b))},jeq:function(){for(var a=1;a<arguments.length;)if(arguments[a++]===arguments[0])return 1},jin:function(a,b){return this.get_parent(a)===b},log:function(){this.env.debug&&"undefined"!=typeof console&&console.log&&console.log.apply(console,arguments)},log_shift:function(a,b){return b>0?a<<b:a>>>-b},output_stream:function(a,b){if(a=f(a),1===a&&(this.streams[0]=1),-1===a&&(this.log("Disabling stream one - it actually happened!"),this.streams[0]=0),3===a&&this.streams[2].unshift([b,""]),-3===a){var c=this.streams[2].shift(),d=this.text_to_zscii(c[1]);this.m.setUint16(c[0],d.length),this.m.setBuffer8(c[0]+2,d)}},_print:function(a){if(this.streams[2].length)this.streams[2][0][1]+=a;else if(this.streams[0]){var b=2&this.m.getUint8(17);b!==(2&this.ui.mono)&&(253&this.ui.mono||this.ui.flush(),this.ui.mono^=2),this.ui.buffer+=a}},print:function(a,b){if(0===a&&(b=""+b),1===a&&(b=String.fromCharCode(b)),2===a&&(b=this.jit[b]||this.decode(b)),3===a){var c=this.m.getUint16(this.objects+(this.version3?9:14)*b+(this.version3?7:12));b=this.decode(c+1,2*this.m.getUint8(c))}if(4===a){if(!this.unicode_table[b])return;b=this.unicode_table[b]}this._print(b)},print_table:function(a,b,c,d){c=c||1,d=d||0;for(var e=0;e++<c;)this._print(this.zscii_to_text(this.m.getBuffer8(a,b))+(c>e?"\r":"")),a+=b+d},put_prop:function(a,b,c){var d,e=this.m,f=this.find_prop(a,b);f&&(d=e.getUint8(f-1),e[(this.version3?d>>5:64&d)?"setUint16":"setUint8"](f,c))},random:function(a){var b=this.xorshift_seed;return 1>a?(this.xorshift_seed=a,0):0===b?1+Math.random()*a|0:(b^=b<<13,b^=b>>17,this.xorshift_seed=b^=b<<5,1+(32767&b)%a)},read:function(a,b,c,d,e){var f,g=this.m.getUint8(b);this.version3?(g--,f={len:g},this.ui.v3_status()):f={len:g,initiallen:this.m.getUint8(b+1),time:d},this.read_data={buffer:b,len:g,parse:c,routine:e,storer:a},this.act("read",f)},read_char:function(a,b,c,d){this.read_data={routine:d,storer:a},this.act("char",{time:c})},remove_obj:function(a){var b,c,d,e=this.get_parent(a);if(0!==e)if(b=this.get_child(e),c=this.get_sibling(a),b===a)this.set_family(a,0,e,c);else{for(;;){if(d=this.get_sibling(b),d===a)break;b=d}this.set_family(a,0,0,0,b,c)}},restart:function(){var b=d.MemoryView(this.data.buffer.slice()),c=b.getUint8(0),f=3===c,g=f?2:5===c?4:8,h=b.getUint16(10),i=b.getUint16(54);if(3!==c&&5!==c&&8!==c)throw new Error("Unsupported Z-Machine version: "+c);this.m&&b.setUint8(17,this.m.getUint8(17)),e(this,{m:b,s:[],l:[],call_stack:[],undo:[],orders:[],streams:[1,0,[],0],version:c,version3:3===c,pc:b.getUint16(6),properties:h,objects:h+(f?53:112),globals:b.getUint16(12),staticmem:b.getUint16(14),eof:(b.getUint16(26)||65536)*g,extension:i,extension_count:i?b.getUint16(i):0,addr_multipler:g,opcodes:a("./opcodes.js")(f)}),this.ui=new(a("./ui.js"))(this),this.init_text(),this.update_header()},restore:function(a){this.save_restore_pc=a,this.act("restore")},restore_file:function(a){var b,c,d=this.m,e=new i.Quetzal(a),f=e.memory,g=e.stacks,j=d.getUint8(17),k=0,l=0,m=[],n=[];if(d.setBuffer8(0,this.data.slice(0,this.staticmem)),e.compressed)for(;k<f.length;)b=f[k++],0===b?l+=1+f[k++]:d.setUint8(l,b^this.data[l++]);else d.setBuffer8(0,f);for(d.setUint8(17,j),k=6,b=g[k++]<<8|g[k++],c=h(g.slice(k,b));k<g.length;){for(m.unshift([g[k++]<<16|g[k++]<<8|g[k++],0,0,c.length,0,n.length]),m[0][1]=16&g[k]?-1:g[k+1],m[0][2]=15&g[k],k+=2,b=g[k++];b;)m[0][4]++,b>>=1;b=2*(g[k++]<<8|g[k++]),n=h(g.slice(k,k+=2*m[0][2])).concat(n),c=c.concat(h(g.slice(k,k+=b)))}this.call_stack=m,this.l=n,this.s=c,this.update_header(),this.save_restore_pc=e.pc,this.save_restore_result(2),this.version3&&this.ui.split_window(0)},restore_undo:function(){if(0===this.undo.length)return 0;var a=this.undo.pop();return this.pc=a[0],a[2][17]=this.m.getUint8(17),this.m.setBuffer8(0,a[2]),this.l=a[3],this.s=a[4],this.call_stack=a[5],this.variable(a[1],2),1},ret:function(a){var b=this.call_stack.shift(),c=b[1];this.pc=b[0],this.l=this.l.slice(this.l.length-b[5]),this.s.length=b[3],c>=0&&this.variable(c,0|a)},save:function(a){var b,c,d,e,f,g=this.m,h=this.s,j=this.l,k=new i.Quetzal,l=[],m=0,n=this.call_stack.reverse(),o=[0,0,0,0,0,0];for(k.release=g.getBuffer8(2,2),k.serial=g.getBuffer8(18,6),k.checksum=g.getBuffer8(28,2),k.pc=a,k.compressed=1,b=0;b<this.staticmem;b++)d=g.getUint8(b)^this.data[b],0===d?256===++m&&(l.push(0,255),m=0):(m&&(l.push(0,m-1),m=0),l.push(d));for(k.memory=l,o.push(n[0][3]>>8,255&n[0][3]),c=0;c<n[0][3];c++)o.push(h[c]>>8,255&h[c]);for(b=0;b<n.length;b++){for(e=n[b],f=(n[b+1]?n[b+1][3]:h.length)-e[3],o.push(e[0]>>16,e[0]>>8&255,255&e[0],e[2]|(e[1]<0?16:0),e[1]<0?0:e[1],(1<<e[4])-1,f>>8,255&f),c=j.length-e[5]-e[2];c<j.length-e[5];c++)o.push(j[c]>>8,255&j[c]);for(c=e[3];c<e[3]+f;c++)o.push(h[c]>>8,255&h[c])}n.reverse(),k.stacks=o,this.save_restore_pc=a,this.act("save",{data:k.write()})},save_restore_result:function(a){var b,c,d,e=this.m,f=this.save_restore_pc;this.version3?(b=e.getUint8(f++),c=128&b,d=64&b?63&b:(b<<8|e.getUint8(f++))<<18>>18,!a==!c?0===d||1===d?this.ret(d):this.pc=d+f-2:this.pc=f):(this.variable(e.getUint8(f++),a),this.pc=f)},save_undo:function(a,b){return this.undo.push([a,b,this.m.getBuffer8(0,this.staticmem),this.l.slice(),this.s.slice(),this.call_stack.slice()]),1},scan_table:function(a,b,c,d){d=d||130;var e=128&d?"getUint16":"getUint8";for(d&=127,c=b+c*d;c>b;){if(this.m[e](b)===a)return b;b+=d}return 0},set_attr:function(a,b){var c=this.objects+(this.version3?9:14)*a+b/8|0;this.m.setUint8(c,this.m.getUint8(c)|128>>b%8)},set_family:function(a,b,c,d,e,f){var g=this.m,h=this.objects;this.version3?(g.setUint8(h+9*a+4,b),c&&g.setUint8(h+9*c+6,d),e&&g.setUint8(h+9*e+5,f)):(g.setUint16(h+14*a+6,b),c&&g.setUint16(h+14*c+10,d),e&&g.setUint16(h+14*e+8,f))},test:function(a,b){return a&b===b},test_attr:function(a,b){return this.m.getUint8(this.objects+(this.version3?9:14)*a+b/8|0)<<b%8&128},update_header:function(){var a=this.m;return this.xorshift_seed=0,this.version3?a.setUint8(1,96|a.getUint8(1)):(a.setUint8(1,29|(this.env.timed?128:0)),a.setUint8(17,87&a.getUint8(17)),a.setUint8(32,255),a.setUint8(33,this.env.width),a.setUint16(34,this.env.width),a.setUint16(36,255),a.setUint16(38,257),a.setUint16(50,258),this.extension_table(4,0),void this.ui.update_header())},variable:function(a,b){var c,d=void 0!==b;if(0===a){if(!d)return this.s.pop();this.s.push(b)}else if(--a<15){if(!d)return this.l[a];this.l[a]=b}else{if(c=this.globals+2*(a-15),!d)return this.m.getUint16(c);this.m.setUint16(c,b)}return b},warn:function(){this.env.debug&&"undefined"!=typeof console&&console.warn&&console.warn.apply(console,arguments)},U2S:f,S2U:g}},{"../common/file.js":2,"../common/utils.js":3,"./opcodes.js":6,"./ui.js":9}],8:[function(a,b,c){for(var d={8:8,13:13,27:27,37:131,38:129,39:132,40:130},e=96;106>e;)d[e]=49+e++;for(e=112;124>e;)d[e]=21+e++;b.exports={init_text:function(){function a(a){for(var b=[[],[],[]],d=0;78>d;)b[d/26|0][d%26]=a[d++];b[2][1]=13,c.alphabets=b}function b(a){for(var b={13:"\r"},d={13:13},e=0;e<a.length;)b[155+e]=String.fromCharCode(a[e]),d[a[e]]=155+e++;for(e=32;127>e;)b[e]=String.fromCharCode(e),d[e]=e++;c.unicode_table=b,c.reverse_unicode_table=d}var c=this,d=this.m,e=!this.version3&&d.getUint16(52),f=this.extension_table(3),g=f&&d.getUint8(f++);this.abbr_addr=d.getUint16(24),a(e?d.getBuffer8(e,78):this.text_to_zscii("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ \r0123456789.,!?_#'\"/\\-:()",1)),b(f?d.getBuffer16(f,g):this.text_to_zscii(unescape("%E4%F6%FC%C4%D6%DC%DF%BB%AB%EB%EF%FF%CB%CF%E1%E9%ED%F3%FA%FD%C1%C9%CD%D3%DA%DD%E0%E8%EC%F2%F9%C0%C8%CC%D2%D9%E2%EA%EE%F4%FB%C2%CA%CE%D4%DB%E5%C5%F8%D8%E3%F1%F5%C3%D1%D5%E6%C6%E7%C7%FE%F0%DE%D0%A3%u0153%u0152%A1%BF"),1)),this.dictionaries={},this.dict=d.getUint16(8),this.parse_dict(this.dict)},decode:function(a,b){var c,d,e,f,g=this.m,h=a,i=[],j=0,k=0,l=[],m=[],n=0;if(this.jit[a])return this.jit[a];for(b=b?b+a:this.eof;b>a&&(c=g.getUint16(a),a+=2,i.push(c>>10&31,c>>5&31,31&c),!(32768&c)););for(;j<i.length;){if(d=i[j++],0===d)l.push(32);else if(4>d)e=1,l.push(-1),m.push("\ue000+this.abbr("+(32*(d-1)+i[j++])+")+\ue000");else if(6>d)k=d;else if(2===k&&6===d){if(j+1<i.length)if(f=i[j++]<<5|i[j++],768>f)l.push(f);else{for(f-=767,n+=f,c=j,j=j%3+3;f--;)l.push(-1),m.push(String.fromCharCode(i[j]<<10|i[j+1]<<5|i[j+2])),i[j++]=i[j++]=i[j++]=32;j=c}}else 32>d&&l.push(this.alphabets[k][d-6]);k=4>k?0:k-3,j%3===0&&(j+=n,n=0)}return l=this.zscii_to_text(l,m),e&&(l={toString:Function('return"'+l.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\r/g,"\\r").replace(/\uE000/g,'"')+'"').bind(this)}),h>=this.staticmem&&(this.jit[h]=l),l},encode:function(a){for(var b,c,d=this.alphabets,e=[],f=this.version3?6:9,g=0,h=[];e.length<f;)b=a[g++],32===b?e.push(0):(c=d[0].indexOf(b))>=0?e.push(c+6):(c=d[1].indexOf(b))>=0?e.push(4,c+6):(c=d[2].indexOf(b))>=0?e.push(5,c+6):(c=this.reverse_unicode_table[b])?e.push(5,6,c>>5,31&c):void 0===b&&e.push(5);for(e.length=f,g=0;f>g;)h.push(e[g++]<<2|e[g]>>3,(7&e[g++])<<5|e[g++]);return h[h.length-2]|=128,h},zscii_to_text:function(a,b){for(var c,d=0,e=a.length,f=0,g="";e>d;)c=a[d++],-1===c&&(g+=b[f++]),(c=this.unicode_table[c])&&(g+=c);return g},text_to_zscii:function(a,b){for(var c,d=[],e=0,f=a.length;f>e;)c=a.charCodeAt(e++),b||(c=this.reverse_unicode_table[c]||63),d.push(c);return d},parse_dict:function(a){var b,c,d=this.m,e=a,f={},g=d.getUint8(a++);for(f.separators=Array.prototype.slice.call(d.getBuffer8(a,g)),a+=g,b=d.getUint8(a++),c=a+2+b*d.getUint16(a),a+=2;c>a;)f[Array.prototype.toString.call(d.getBuffer8(a,this.version3?4:6))]=a,a+=b;return this.dictionaries[e]=f,f},abbr:function(a){return this.decode(2*this.m.getUint16(this.abbr_addr+2*a))},tokenise:function(a,b,c,d){c=c||this.dict,c=this.dictionaries[c]||this.parse_dict(c);var e,f,g,h,i=this.m,j=1e3,k=1,l=c.separators,m=[],n=0;for(this.version3||(j=i.getUint8(a+k++)+2);j>k&&(e=i.getUint8(a+k),0!==e);)32===e||l.indexOf(e)>=0?(32!==e&&m.push([[e],k]),f=null):(f||(m.push([[],k]),f=m[m.length-1][0]),f.push(e)),k++;for(g=Math.min(m.length,i.getUint8(b));g>n;)h=c[""+this.encode(m[n][0])],(!d||h)&&(i.setUint16(b+2+4*n,h||0),i.setUint8(b+4+4*n,m[n][0].length),i.setUint8(b+5+4*n,m[n][1])),n++;i.setUint8(b+1,n)},keyinput:function(a){return d[a.keyCode]||this.reverse_unicode_table[a.charCode]||63}}},{}],9:[function(a,b,c){var d=a("../common/utils.js"),e=d.Class;b.exports=e.subClass({init:function(a){this.e=a,this.buffer="",d.extend(this,this.formatters[a.env.formatter]||{}),this.e.env.debug&&(this.reverse=0,this.bold=0,this.italic=0,this.fg=void 0,this.bg=void 0),this.time=2&a.m.getUint8(1),this.mono=2&a.m.getUint8(17),this.process_colours(),this.currentwin=0,this.status=[],a.orders.push({code:"stream",name:"status"},{code:"stream",name:"main"},{code:"find",name:"main"})},clear_window:function(){this.e.orders.push({code:"clear",name:"main",bg:this.bg})},erase_line:function(a){1===a&&(this.flush(),this.status.push({code:"eraseline"}))},erase_window:function(a){this.flush(),1>a&&this.clear_window(),-1===a&&this.split_window(0),(-2===a||1===a)&&this.status.push({code:"clear"})},flush:function(){if(""!==this.buffer){var a={code:"stream",text:this.buffer,props:this.format()};(this.currentwin?this.status:this.e.orders).push(a),this.buffer=""}},format:function(){var a,b={},c=[],d=this.fg,e=this.bg;return this.bold&&c.push("zvm-bold"),this.italic&&c.push("zvm-italic"),this.mono&&c.push("zvm-mono"),this.reverse&&(a=d,d=e||this.env.bg,e=a||this.env.fg),"undefined"!=typeof d&&(isNaN(d)?b.css={color:d}:c.push("zvm-fg-"+d)),"undefined"!=typeof e&&(isNaN(e)?(b.css||(b.css={}),b.css["background-color"]=e):c.push("zvm-bg-"+e)),c.length&&(b["class"]=c.join(" ")),b},get_cursor:function(a){this.status.push({code:"get_cursor",addr:a}),this.e.act()},process_colours:function(){function a(a){var b,c=Math.round,d=/(\d+),\s*(\d+),\s*(\d+)|#(\w{1,2})(\w{1,2})(\w{1,2})/.exec(a);return d[1]?b=[d[1],d[2],d[3]]:(b=[parseInt(d[4],16),parseInt(d[5],16),parseInt(d[6],16)],4===a.length&&(b=[b[0]<<4|b[0],b[1]<<4|b[1],b[2]<<4|b[2]])),c(b[2]/8.226)<<10|c(b[1]/8.226)<<5|c(b[0]/8.226)}var b=[65534,65535,0,29,832,957,22944,31775,30624,32767,23254,17969,11627],c=this.e.env.fgcolour,d=this.e.env.bgcolour,e=c?a(c):65535,f=d?a(d):65535,g=b.indexOf(e),h=b.indexOf(f);2>g&&(g=c||2),2>h&&(h=d||9),this.env={fg:g,bg:h,fg_true:e,bg_true:f}},set_colour:function(a,b){this.flush(),1===a&&(this.fg=void 0),a>1&&13>a&&(this.fg=a),1===b&&(this.bg=void 0),b>1&&13>b&&(this.bg=b)},set_cursor:function(a,b){this.flush(),this.status.push({code:"cursor",to:[a-1,b-1]})},set_font:function(a){if(1!==a&&4!==a)return 0;var b=4&this.mono?4:1;return a!==b&&(this.flush(),this.mono^=4),b},set_style:function(a){this.flush(),0===a&&(this.reverse=this.bold=this.italic=0,this.mono&=254),1&a&&(this.reverse=1),2&a&&(this.bold=1),4&a&&(this.italic=1),8&a&&(this.mono|=1)},set_true_colour:function(a,b){function c(a){var b=Math.round(8.226*(31&a))<<16|Math.round(8.226*((992&a)>>5))<<8|Math.round(8.226*((31744&a)>>10));for(b=b.toString(16);b.length<6;)b="0"+b;return"#"+b}this.flush(),65535===a?this.fg=void 0:32768>a&&(this.fg=c(a)),65535===b?this.bg=void 0:32768>b&&(this.bg=c(b))},set_window:function(a){this.flush(),this.currentwin=a,this.e.orders.push({code:"find",name:a?"status":"main"}),a&&this.status.push({code:"cursor",to:[0,0]})},split_window:function(a){this.flush(),this.status.push({code:"height",lines:a}),this.e.version3&&this.status.push({code:"clear"})},update_header:function(){var a=this.e.m;a.setUint8(44,isNaN(this.env.bg)?1:this.env.bg),a.setUint8(45,isNaN(this.env.fg)?1:this.env.fg),this.e.extension_table(5,this.env.fg_true),this.e.extension_table(6,this.env.bg_true)},v3_status:function(){var a,b=this.e,c=b.env.width,d=b.m.getUint16(b.globals+2),e=b.m.getUint16(b.globals+4);
this.set_window(1),this.set_style(1),b._print(Array(c+1).join(" ")),this.set_cursor(1,1),a=this.time?"Time: "+(d%12===0?12:d%12)+":"+(10>e?"0":"")+e+" "+(d>11?"PM":"AM"):"Score: "+d+"  Turns: "+e,b.print(3,b.m.getUint16(b.globals)),this.buffer=" "+this.buffer.slice(0,c-a.length-4),this.set_cursor(1,c-a.length),b._print(a),this.set_style(0),this.set_window(0)},formatters:{}})},{"../common/utils.js":3}]},{},[4])(4)});